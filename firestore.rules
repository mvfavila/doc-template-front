rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if isSystemAdmin();
    }
    
    match /offices/{officeId} {
      allow read: if isSystemAdmin() || isOfficeAdmin(officeId);
      allow write: if isSystemAdmin();
    }
    
    match /templates/{templateId} {
      allow read: if isOfficeAdmin(resource.data.officeId);
      allow write: if isOfficeAdmin(request.resource.data.officeId);
    }
    
    match /forms/{formId} {
      allow read: if isOfficeAdmin(resource.data.officeId) || 
                    (isCustomer() && resource.data.customerId == request.auth.uid);
      allow update: if (isOfficeAdmin(resource.data.officeId) || 
                      (isCustomer() && resource.data.customerId == request.auth.uid && 
                       resource.data.status == "pending"));
    }
    
    function isSystemAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "system_admin";
    }
    
    function isOfficeAdmin(officeId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "office_admin" &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.officeId == officeId;
    }
    
    function isCustomer() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "customer";
    }
  }
}